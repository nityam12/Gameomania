const autoscroll=e=>{const o=document.getElementById("chat-messages-list"),t=o.lastElementChild;console.log(t);const s=window.getComputedStyle(t),a=parseInt(s.marginBottom),n=t.offsetHeight+a,i=o.offsetHeight;o.scrollHeight-n<=o.scrollTop+i&&(o.scrollTop=o.scrollHeight)};class ChatEngine{constructor(e,o,t,s,a,n){this.chatBox=$("#"+e),this.userEmail=o,this.userName=t,this.id1=s,this.id2=a,this.socket=io.connect("http://localhost:5000"),this.chatBoxId=e,this.chatroom=n,this.userEmail&&this.connectionHandler()}connectionHandler(){let e=this;this.socket.on("connect",(function(){console.log("connection established using sockets...!"),e.socket.emit("join_room",{user_email:e.userEmail,chatroom:e.chatroom,user_name:e.userName,id1:e.id1,id2:e.id2}),e.socket.on("user_joined",(function(e){console.log("a user joined!",e)}))})),$("#send-message").click((function(){const o=$(this),t=$("#chat-message-input").val();$("#chat-message-input").val(""),o.attr("disabled",!0),""!=t?e.socket.emit("send_message",{message:t,user_email:e.userEmail,chatroom:e.chatroom,user_name:e.userName},e=>{o.attr("disabled",!1),$("#chat-message-input").focus(),e&&console.log(e),console.log(" Message delivered!")}):o.attr("disabled",!1)})),e.socket.on("receive_message",(function(o){console.log("message received",o.text);let t=$("<li>"),s="other-message";o.user_email==e.userEmail&&(s="self-message"),t.append($("<span>",{html:o.text})),t.prepend($("<sup>",{html:o.user_name})),t.append($("<sub>",{html:moment(o.createdAt).format("h:mm a")})),t.addClass(s),$("#chat-messages-list").append(t),autoscroll(e.chatBoxId)}),e=>{e&&console.log(e),console.log(" Message received!")}),$("#share-location").click((function(){const o=$(this);if(!navigator.geolocation)return alert("Geolocation is not supported by your browser");function t(e){console.error(`ERROR(${t.code}): ${e.message}`)}function s(t){navigator.geolocation.getCurrentPosition(t=>{e.socket.emit("sendlocation",{latitude:t.coords.latitude,longitude:t.coords.longitude,user_email:e.userEmail,chatroom:e.chatroom,user_name:e.user_name},()=>{o.attr("disabled",!1),console.log("Location shared")})})}o.attr("disabled",!0),navigator.geolocation.getCurrentPosition(s,t)})),e.socket.on("receive_location",(function(o){console.log("location received",o.message);let t=$("<li>"),s="other-message";o.user_email==e.userEmail&&(s="self-message");const a=$("<a>My Current Location</a>");a.attr("href",o.url),a.attr("target","_blank"),t.append($("<span>",{html:a})),t.prepend($("<sup>",{html:o.user_email})),t.append($("<sub>",{html:moment(o.createdAt).format("h:mm a")})),t.addClass(s),$("#chat-messages-list").append(t),autoscroll(e.chatBoxId)}))}}